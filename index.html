<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barzakh : Mobile Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Amiri:wght@400;700&family=Roboto+Mono:wght@500&display=swap');

        :root {
            --bg-dark: #020202;
            --gold: #D4AF37;
            --blue-light: #4fc3f7;
            --danger: #a00000;
            --fire-defeat: #ff4500;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-dark);
            color: #fff;
            font-family: 'Amiri', serif;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; width: 100vw;
            user-select: none; 
            touch-action: none; /* Bloque le scroll et le zoom sur mobile */
            -webkit-tap-highlight-color: transparent; /* EnlÃ¨ve le flash gris au clic */
        }

        #game-container {
            position: relative; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #141414 0%, #000000 90%);
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* --- INTRO CINEMATIQUE (CSS) --- */
        #intro-animation-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
        }
        .play-anim { animation: sequenceIntro 5s forwards; pointer-events: auto !important; opacity: 1 !important; }

        .logo-deen {
            font-family: 'Cinzel', serif; font-weight: 900; font-size: 10vw; /* Responsive font */
            background: linear-gradient(to bottom, #cfc09f 22%, #634f2c 24%, #cfc09f 26%, #cfc09f 27%, #ffecb3 40%, #3a2c0f 78%); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 50px rgba(212, 175, 55, 0.3); opacity: 0; transform: scale(0.8); text-align: center;
        }
        
        .logo-gaming {
            font-family: 'Cinzel', serif; font-weight: 400; font-size: 4vw; letter-spacing: 1.5vw;
            color: #fff; margin-top: 10px; opacity: 0; transform: translateY(20px); text-shadow: 0 0 10px #4fc3f7; text-align: center;
        }

        @keyframes sequenceIntro {
            0%, 10%, 15% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }
        .anim-text-1 { animation: textReveal 4s forwards 0.5s; }
        .anim-text-2 { animation: subReveal 4s forwards 1.5s; }
        @keyframes textReveal {
            0% { opacity: 0; transform: scale(0.8); filter: blur(10px); }
            20% { opacity: 1; transform: scale(1); filter: blur(0px); }
            80% { opacity: 1; transform: scale(1.05); filter: blur(0px); }
            100% { opacity: 0; transform: scale(1.1); filter: blur(5px); }
        }
        @keyframes subReveal {
            0% { opacity: 0; transform: translateY(20px); letter-spacing: 3vw; }
            20% { opacity: 1; transform: translateY(0); letter-spacing: 1.5vw; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* --- OVERLAYS --- */
        #damage-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, transparent 40%, rgba(180, 0, 0, 0.8) 100%); opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 5; }
        #victory-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 40; }
        .burst-light { animation: lightBurst 6s forwards ease-in-out; }
        @keyframes lightBurst { 0% { opacity: 0; } 20% { opacity: 1; background: white; } 100% { opacity: 0.95; background: radial-gradient(circle, #ffffff, #e1f5fe); } }
        #defeat-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at center, transparent 30%, var(--danger) 70%, var(--fire-defeat) 100%); opacity: 0; pointer-events: none; z-index: 40; mix-blend-mode: hard-light; }
        .fire-halo { animation: firePulse 2s infinite alternate ease-in-out; opacity: 0.8 !important; }
        @keyframes firePulse { 0% { filter: brightness(1); } 100% { filter: brightness(1.3) hue-rotate(-10deg); } }

        #istighfar-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Cinzel', serif; font-size: 8vw; font-weight: bold; color: #fff;
            text-shadow: 0 0 20px var(--gold), 0 0 50px var(--blue-light);
            pointer-events: none; opacity: 0; z-index: 35; letter-spacing: 10px; white-space: nowrap;
        }
        .anim-istighfar { animation: istighfarBoom 2.5s ease-out forwards; }
        @keyframes istighfarBoom {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); letter-spacing: 50px; }
            10% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); letter-spacing: 10px; }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); letter-spacing: 20px; }
        }

        /* UI */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 30; }
        .hud-top { text-align: center; padding-top: 5vh; font-family: 'Cinzel', serif; text-shadow: 0 0 10px #000; }
        #dragon-counter { font-size: 2.5rem; color: #fff; text-shadow: 0 0 15px var(--danger); transition: color 0.3s; }
        .counter-danger { color: #ff4500 !important; animation: pulseText 0.5s infinite; }
        .hud-bottom { padding-bottom: 5vh; display: flex; flex-direction: column; align-items: center; }
        .ulti-bar-container { width: 80%; max-width: 300px; height: 12px; background: #222; border: 2px solid #555; border-radius: 6px; overflow: hidden; margin-top: 10px; box-shadow: 0 0 10px #000; }
        .ulti-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #fff, #4fc3f7, #fff); box-shadow: 0 0 20px #4fc3f7; transition: width 0.1s linear; }
        .ulti-text { font-family: 'Cinzel', serif; font-size: 1rem; color: #4fc3f7; opacity: 0.8; letter-spacing: 2px; text-shadow: 0 0 5px #000; }
        .ulti-ready { color: #fff; font-weight: bold; text-shadow: 0 0 15px #4fc3f7, 0 0 30px #fff; animation: pulseText 0.5s infinite alternate; }
        @keyframes pulseText { from { transform: scale(1); } to { transform: scale(1.08); } }
        
        .memory-flash {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 5vw; /* Responsive font */
            font-style: italic; color: #fff; text-shadow: 0 0 20px var(--gold), 0 0 40px var(--gold);
            pointer-events: none; opacity: 0; transition: opacity 0.3s, transform 1s ease-out; white-space: nowrap; z-index: 25;
        }
        #gamepad-status { font-size: 0.8rem; color: #444; margin-top: 5px; font-weight: bold; display: flex; align-items: center; gap: 5px; justify-content: center; }
        .gp-active { color: #4CAF50 !important; text-shadow: 0 0 10px #4CAF50; }
        .gp-icon { width: 15px; height: 10px; border: 1px solid currentColor; border-radius: 3px; display: inline-block; }

        /* SCREENS */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.97); display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; pointer-events: auto; text-align: center; transition: opacity 0.5s; padding: 20px; box-sizing: border-box;
        }
        .hidden { display: none !important; opacity: 0; }
        .visible { opacity: 1; }

        h1 { font-family: 'Cinzel', serif; font-size: 8vw; /* Responsive */ color: var(--gold); margin-bottom: 15px; text-shadow: 0 0 20px var(--gold); border-bottom: 1px solid #333; padding-bottom: 10px; }
        .sacred-text { font-size: 1.2rem; color: #ddd; max-width: 800px; line-height: 1.6; margin-bottom: 20px; }
        .source-ref { display: block; margin-top: 15px; font-size: 0.9rem; color: #888; font-style: italic; }
        
        .btn-start {
            padding: 15px 40px; background: rgba(0,0,0,0.5); border: 2px solid var(--gold);
            color: var(--gold); font-family: 'Cinzel', serif; font-size: 1.5rem;
            cursor: pointer; transition: 0.3s; z-index: 60; margin-top: 20px;
            /* Pour mobile : zone de touche plus grande */
            min-width: 200px; min-height: 60px;
        }
        .btn-start:hover, .btn-start:active { background: var(--gold); color: #000; box-shadow: 0 0 40px var(--gold); }
        .btn-gamepad-hint { font-size: 0.8rem; color: #4fc3f7; margin-top: 10px; font-style: italic; }

        /* CONTROLS UI */
        .controls-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin: 20px 0; }
        .control-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; border: 1px solid #333; display: flex; flex-direction: column; align-items: center; width: 140px; min-width: 40%; }
        .control-title { color: var(--blue-light); font-family: 'Cinzel'; margin-bottom: 10px; font-size: 1rem; }
        
        /* Mobile Touch Icons */
        .touch-icon { width: 50px; height: 50px; border: 2px solid #666; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-bottom: 5px; position: relative;}
        .touch-tap { width: 30px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 50%; animation: tapAnim 1s infinite; }
        @keyframes tapAnim { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }

    </style>
</head>
<body>

    <audio id="audio-victory" src="https://everyayah.com/data/Alafasy_128kbps/041030.mp3" preload="auto"></audio>
    <audio id="audio-defeat-99" src="https://everyayah.com/data/Alafasy_128kbps/023099.mp3" preload="auto"></audio>
    <audio id="audio-defeat-100" src="https://everyayah.com/data/Alafasy_128kbps/023100.mp3" preload="auto"></audio>

    <div id="game-container">
        
        <div id="intro-animation-container">
            <div id="logo-deen" class="logo-deen">DEENVERTISSEMENT</div>
            <div id="logo-gaming" class="logo-gaming">GAMING</div>
        </div>

        <div id="screen-prelaunch" class="screen visible" style="z-index: 200; background: #000;">
            <div style="font-family:'Cinzel'; color:#666; font-size:0.9rem; margin-bottom:20px;">INITIALISATION SYSTÃˆME...</div>
            <button class="btn-start" onclick="playIntro()">LANCER</button>
            <div class="btn-gamepad-hint">Toucher pour commencer</div>
        </div>

        <canvas id="gameCanvas"></canvas>
        <div id="damage-overlay"></div>
        <div id="victory-overlay"></div>
        <div id="defeat-overlay"></div>
        <div id="istighfar-overlay">ISTIGHFAR</div>

        <div class="ui-layer">
            <div class="hud-top">
                <span style="font-size: 1rem; color: #aaa; font-family: Cinzel;">DRAGONS</span><br>
                <div id="dragon-counter">0 / 99</div>
                <div id="gamepad-status"><span class="gp-icon"></span> MANETTE OK</div>
            </div>
            <div id="memory-text" class="memory-flash"></div>
            <div class="hud-bottom">
                <div id="ulti-text" class="ulti-text">Larme de Regret</div>
                <div class="ulti-bar-container"><div id="ulti-bar" class="ulti-bar-fill"></div></div>
                <div style="font-size: 0.8rem; color: #aaa; margin-top: 8px; font-family: Cinzel;">CLIC CENTRE / BOUTON A</div>
            </div>
        </div>

        <div id="screen-intro-1" class="screen hidden">
            <h1 style="font-size: 2.5rem;">L'AVERTISSEMENT</h1>
            <div class="sacred-text" style="font-size: 1rem;">
                "On prÃ©posera au mÃ©crÃ©ant dans sa tombe <span style="color:var(--danger)">quatre-vingt-dix-neuf dragons</span>... ils le mordront et le grifferont jusqu'au Jour de la RÃ©surrection."
            </div>
            <button class="btn-start" onclick="nextScreen()">SUIVANT</button>
        </div>

        <div id="screen-intro-2" class="screen hidden">
            <h1 style="font-size: 2.5rem;">RÃˆGLES</h1>
            <div class="sacred-text" style="text-align: left; font-size: 1rem;">
                <p>1. <strong>SURVIVRE</strong> : Repoussez 99 dragons.</p>
                <p>2. <strong>TACTILE</strong> : Tapez sur les boucliers (Haut, Bas, Gauche, Droite) pour les rÃ©parer.</p>
                <p>3. <strong>ISTIGHFAR</strong> : Tapez au <strong>CENTRE</strong> quand la jauge est pleine.</p>
            </div>
            <button class="btn-start" onclick="nextScreen()">SUIVANT</button>
        </div>

        <div id="screen-intro-3" class="screen hidden">
            <h1 style="font-size: 2.5rem;">CONTRÃ”LES</h1>
            <div class="controls-container">
                <div class="control-box">
                    <div class="control-title">TACTILE</div>
                    <div class="touch-icon"><div class="touch-tap"></div></div>
                    <div style="font-size:0.8rem; color:#888;">Tapez sur les cÃ´tÃ©s</div>
                </div>
                <div class="control-box">
                    <div class="control-title">MANETTE</div>
                    <div style="font-size:2rem;">ðŸŽ®</div>
                    <div style="font-size:0.8rem; color:#888;">Croix + A</div>
                </div>
            </div>
            <button class="btn-start" onclick="startGame()">COMMENCER</button>
        </div>

        <div id="game-over-screen" class="screen hidden">
            <h1 style="color: #ff4500;">Ã‰CHEC</h1>
            <div class="sacred-text" style="color: #ffcccb; font-size: 1rem;">
                "Mon Seigneur ! Fais-moi revenir..."<br>
                DerriÃ¨re eux, il y a une barriÃ¨re <span style="color:#ff6b6b">(BARZAKH)</span>.
            </div>
            <button class="btn-start" style="border-color: #ff4500; color: #ff4500;" onclick="startGame()">RECOMMENCER</button>
        </div>

        <div id="victory-screen" class="screen hidden" style="background: transparent;">
            <h1 style="color: #fff;">RÃ‰USSITE</h1>
            <div class="sacred-text" style="color: #fff; font-size: 1.2rem;">
                "N'ayez crainte et ne soyez pas affligÃ©s..."<br>
                (Coran 41:30)
            </div>
            <button class="btn-start" style="border-color: #fff; color: #fff;" onclick="startGame()">RENAÃŽTRE</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const memText = document.getElementById('memory-text');
        const damageOverlay = document.getElementById('damage-overlay');
        const vicOverlay = document.getElementById('victory-overlay');
        const defOverlay = document.getElementById('defeat-overlay');
        const istighfarOverlay = document.getElementById('istighfar-overlay');
        const ultiBar = document.getElementById('ulti-bar');
        const ultiText = document.getElementById('ulti-text');
        const gpStatus = document.getElementById('gamepad-status');
        const dragonCounter = document.getElementById('dragon-counter');
        const audioVic = document.getElementById('audio-victory');
        const audioDef99 = document.getElementById('audio-defeat-99');
        const audioDef100 = document.getElementById('audio-defeat-100');
        
        audioDef99.onended = function() { audioDef100.play(); };

        const SINS = ["Orgueil", "Mensonge", "Regard", "ColÃ¨re", "Riba", "NÃ©gligence", "Rancune", "Injustice"];
        const MEMORIES = {
            'top': ["PriÃ¨res nocturnes", "Larmes de crainte", "Prosternation", "Laylat al-Qadr"],
            'right': ["JeÃ»ne", "Soif pour Allah", "Iftar partagÃ©"],
            'left': ["Zakat purifiÃ©e", "AumÃ´ne secrÃ¨te", "Soutien orphelin", "Aide veuve"],
            'bottom': ["Sourire", "Pardon", "VÃ©ritÃ©", "Visite malade"]
        };
        const SHIELDS = { top: { color: '#4fc3f7', label: 'PRIÃˆRE' }, right: { color: '#66bb6a', label: 'JEÃ›NE' }, bottom: { color: '#ab47bc', label: 'BONTÃ‰' }, left: { color: '#ffa726', label: 'ZAKAT' } };

        let width, height, cx, cy, minDim, animationId;
        const TOTAL_DRAGONS = 3;
        let game = { active: false, frame: 0, spawnedCount: 0, defeatedCount: 0, enemies: [], particles: [], shields: {}, ulti: 0, shake: 0 };
        let gamepadConnected = false;
        let currentScreen = 0; 
        let lastInputTime = 0;
        let gameStartTime = 0;

        // RESPONSIVE RESIZE
        function resize() { 
            width = canvas.width = window.innerWidth; 
            height = canvas.height = window.innerHeight; 
            cx = width/2; cy = height/2;
            minDim = Math.min(width, height); // Base pour le scaling
        }
        window.addEventListener('resize', resize);

        // INTRO
        function playIntro() {
            document.getElementById('screen-prelaunch').classList.remove('visible');
            document.getElementById('screen-prelaunch').classList.add('hidden');
            currentScreen = 1;
            const container = document.getElementById('intro-animation-container');
            const logo1 = document.getElementById('logo-deen');
            const logo2 = document.getElementById('logo-gaming');
            container.classList.add('play-anim');
            logo1.classList.add('anim-text-1');
            logo2.classList.add('anim-text-2');
            setTimeout(() => { endIntro(); }, 5000);
        }
        function endIntro() {
            document.getElementById('intro-animation-container').style.display = 'none';
            currentScreen = 2;
            document.getElementById('screen-intro-1').classList.remove('hidden');
            document.getElementById('screen-intro-1').classList.add('visible');
        }

        // CLASSES RESPONSIVE
        class Shield {
            constructor(k, a) { this.key = k; this.label = SHIELDS[k].label; this.color = SHIELDS[k].color; this.angle = a; this.energy = 100; this.width = Math.PI/2.2; this.pulse = 0; }
            draw() {
                if(this.energy <= 0) return;
                // Calcul rayon responsive
                let radius = minDim * 0.35; // 35% de la taille min
                
                ctx.save(); ctx.translate(cx, cy); ctx.rotate(this.angle);
                let alpha = this.energy/100; if(this.pulse > 0) this.pulse -= 2; let glow = (this.pulse > 0) ? 30 : 15;
                ctx.shadowBlur = glow*alpha; ctx.shadowColor = this.color; ctx.strokeStyle = this.color; 
                ctx.lineWidth = minDim * 0.02; // Epaisseur responsive
                ctx.lineCap = "round"; ctx.globalAlpha = Math.max(0.15, alpha);
                
                ctx.beginPath(); ctx.arc(0,0,radius,-this.width/2,this.width/2); ctx.stroke();
                ctx.lineWidth = minDim * 0.005; 
                ctx.beginPath(); ctx.arc(0,0,radius-(minDim*0.04),-this.width/2*alpha,this.width/2*alpha); ctx.stroke();
                ctx.restore();

                let td = radius + (minDim * 0.1); 
                let tx = cx + Math.cos(this.angle)*td, ty = cy + Math.sin(this.angle)*td;
                ctx.save(); ctx.fillStyle = this.color; ctx.globalAlpha = Math.max(0.5, alpha); 
                ctx.font = `bold ${minDim*0.05}px Cinzel`; // Font responsive
                ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.shadowBlur = 10; ctx.shadowColor = "#000"; 
                if(this.key === 'bottom') ty -= 10; ctx.fillText(this.label, tx, ty); ctx.restore();
            }
            repair() { if(this.energy>0 && this.energy<100) { this.energy = Math.min(100, this.energy+30); this.pulse = 20; triggerMemory(this.key); createParticles(cx+Math.cos(this.angle)*minDim*0.35, cy+Math.sin(this.angle)*minDim*0.35, "#fff", 12); } }
        }

        class Enemy {
            constructor() {
                let s = Math.floor(Math.random()*4);
                if(s===0) { this.x = Math.random()*width; this.y = -50; } else if(s===1) { this.x = width+50; this.y = Math.random()*height; } else if(s===2) { this.x = Math.random()*width; this.y = height+50; } else { this.x = -50; this.y = Math.random()*height; }
                this.label = SINS[Math.floor(Math.random()*SINS.length)];
                let progress = game.spawnedCount / TOTAL_DRAGONS; 
                // Vitesse responsive (pixel par frame relatif Ã  la taille)
                let baseSpeed = minDim * 0.003; 
                this.speed = baseSpeed + (progress * baseSpeed * 2); 
                this.alive = true; this.segments = Array(8).fill({x:this.x, y:this.y});
            }
            update() {
                let dx = cx-this.x, dy = cy-this.y; let dist = Math.sqrt(dx*dx + dy*dy); let angle = Math.atan2(dy, dx);
                this.x += Math.cos(angle)*this.speed; this.y += Math.sin(angle)*this.speed;
                this.segments.pop(); this.segments.unshift({x:this.x, y:this.y});
                if (dist < minDim * 0.8) damageOverlay.style.opacity = (Math.sin(game.frame*0.25)+1)*0.4 * (1-(dist/(minDim*0.8)));
                if(dist < minDim * 0.05) { this.alive = false; gameOver(); }
            }
            draw() {
                ctx.save(); ctx.strokeStyle = "#a00"; ctx.lineWidth = minDim*0.01; ctx.lineCap = "round"; ctx.shadowBlur = 10; ctx.shadowColor = "#500";
                ctx.beginPath(); ctx.moveTo(this.segments[0].x, this.segments[0].y);
                for(let i=1; i<this.segments.length; i++) { let w = Math.sin(game.frame*0.4 + i)*(minDim*0.015); ctx.lineTo(this.segments[i].x + w, this.segments[i].y + w); }
                ctx.stroke(); ctx.fillStyle = "#f00"; ctx.beginPath(); ctx.arc(this.x,this.y,minDim*0.015,0,Math.PI*2); ctx.fill(); 
                ctx.fillStyle = "#ffcccc"; ctx.font = `bold ${minDim*0.035}px Amiri`; ctx.fillText(this.label, this.x, this.y-(minDim*0.04)); ctx.restore();
            }
        }

        class Shockwave {
            constructor() { this.r = 10; this.active = true; }
            update() {
                this.r += minDim * 0.05; if(this.r > Math.max(width,height)*1.5) this.active = false;
                game.enemies.forEach(e => { if(e.alive && Math.sqrt(Math.pow(e.x-cx,2)+Math.pow(e.y-cy,2)) < this.r) { e.alive = false; killEnemy(e); game.shake = 10; } });
            }
            draw() { ctx.save(); ctx.beginPath(); ctx.arc(cx, cy, this.r, 0, Math.PI*2); ctx.strokeStyle = "#fff"; ctx.lineWidth = minDim*0.2; ctx.shadowBlur = 60; ctx.shadowColor = "#4fc3f7"; ctx.globalAlpha = 1 - (this.r/(Math.max(width,height)*1.5)); ctx.stroke(); ctx.restore(); }
        }

        function createParticles(x, y, c, n) { for(let i=0; i<n; i++) game.particles.push({x:x, y:y, vx:(Math.random()-0.5)*minDim*0.03, vy:(Math.random()-0.5)*minDim*0.03, life:1, color:c}); }
        function triggerMemory(k) { let l = MEMORIES[k]; memText.textContent = `"${l[Math.floor(Math.random()*l.length)]}"`; memText.style.opacity = 1; memText.style.transform = "translate(-50%, -120%) scale(1.1)"; setTimeout(() => { memText.style.opacity = 0; memText.style.transform = "translate(-50%, -50%)"; }, 1200); game.ulti = Math.min(100, game.ulti+5); updateUlti(); }
        function killEnemy(e) { createParticles(e.x, e.y, "#fff", 20); game.defeatedCount++; updateHUD(); if(game.defeatedCount >= TOTAL_DRAGONS) winGame(); }
        function updateHUD() { dragonCounter.textContent = `${game.spawnedCount} / ${TOTAL_DRAGONS}`; if(game.spawnedCount > 85) dragonCounter.classList.add('counter-danger'); else dragonCounter.classList.remove('counter-danger'); }
        
        function triggerUlti() {
            if (Date.now() - gameStartTime < 1000) return;
            if(game.ulti >= 100) {
                game.ulti = 0; updateUlti();
                istighfarOverlay.classList.remove('anim-istighfar'); void istighfarOverlay.offsetWidth; istighfarOverlay.style.opacity = 1; istighfarOverlay.classList.add('anim-istighfar');
                game.particles.push(new Shockwave()); game.shake = 50; ctx.fillStyle = "white"; ctx.fillRect(0,0,width,height);
                game.enemies.forEach(e => { if(e.alive) { e.alive = false; killEnemy(e); } });
            }
        }
        function updateUlti() { ultiBar.style.width = `${game.ulti}%`; if(game.ulti >= 100) { ultiText.textContent = "REPENTIR ACCEPTÃ‰ !"; ultiText.classList.add('ulti-ready'); } else { ultiText.textContent = "Larme de Regret (Istighfar)"; ultiText.classList.remove('ulti-ready'); } }

        function update() {
            game.frame++; if(game.shake > 0) game.shake *= 0.9;
            let spawnRate = Math.max(15, 90 - (game.spawnedCount * 0.8)); 
            if(game.spawnedCount < TOTAL_DRAGONS && game.frame % Math.floor(spawnRate) === 0) { game.enemies.push(new Enemy()); game.spawnedCount++; updateHUD(); }
            game.enemies.forEach(e => e.update());
            game.enemies = game.enemies.filter(e => {
                if(!e.alive) return false;
                let d = Math.sqrt(Math.pow(e.x-cx,2)+Math.pow(e.y-cy,2));
                // Collision responsive
                let shieldRadius = minDim * 0.35;
                if(d < shieldRadius + (minDim*0.05) && d > shieldRadius - (minDim*0.05)) {
                    let s = null, dx = e.x-cx, dy = e.y-cy;
                    if(Math.abs(dx)>Math.abs(dy)) s = (dx>0)?game.shields.right:game.shields.left; else s = (dy>0)?game.shields.bottom:game.shields.top;
                    if(s && s.energy>0) { s.energy -= 34; createParticles(e.x,e.y,s.color,8); game.shake+=3; killEnemy(e); return false; }
                }
                return true;
            });
            game.particles.forEach(p => { if(p instanceof Shockwave) p.update(); else { p.x+=p.vx; p.y+=p.vy; p.life-=0.04; } });
            game.particles = game.particles.filter(p => p.active!==false && p.life>0);
        }

        function draw() {
            let sx = (Math.random()-0.5)*game.shake, sy = (Math.random()-0.5)*game.shake;
            ctx.save(); ctx.translate(sx, sy); ctx.fillStyle = 'rgba(0,0,0,0.35)'; ctx.fillRect(-20,-20,width+40,height+40);
            
            // Joueur responsive
            ctx.translate(cx, cy); ctx.shadowBlur = 30; ctx.shadowColor = "#fff"; ctx.fillStyle = "#fff"; 
            ctx.beginPath(); ctx.ellipse(0,0,minDim*0.04, minDim*0.1, 0,0,Math.PI*2); ctx.fill(); 
            ctx.translate(-cx, -cy);

            Object.values(game.shields).forEach(s => s.draw()); game.enemies.forEach(e => e.draw());
            game.particles.forEach(p => { if(p instanceof Shockwave) p.draw(); else { ctx.globalAlpha = p.life; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x,p.y,minDim*0.008,0,Math.PI*2); ctx.fill(); } });
            ctx.restore();
        }
        function loop() { if(game.active) { update(); draw(); animationId = requestAnimationFrame(loop); } }

        /* INPUTS AMÃ‰LIORÃ‰S (TACTILE + SOURIS) */
        function handleInput(x, y) {
            if(!game.active) return;
            let d = Math.sqrt(Math.pow(x-cx,2)+Math.pow(y-cy,2));
            // Zone centrale responsive (20% du minDim) pour l'Ulti
            if(d < minDim * 0.2) { triggerUlti(); return; }
            
            let dx = x-cx, dy = y-cy; 
            if(Math.abs(dx)>Math.abs(dy)) { (dx>0)?game.shields.right.repair():game.shields.left.repair(); } else { (dy>0)?game.shields.bottom.repair():game.shields.top.repair(); }
        }
        
        // Touchstart avec preventDefault pour Ã©viter zoom/scroll
        window.addEventListener('touchstart', e => { 
            if(game.active) e.preventDefault(); 
            handleInput(e.touches[0].clientX, e.touches[0].clientY); 
        }, {passive:false});

        window.addEventListener('mousedown', e => handleInput(e.clientX, e.clientY));
        
        window.addEventListener('keydown', e => {
            if(!game.active) return;
            switch(e.code) { case 'Space': triggerUlti(); break; case 'ArrowUp': case 'KeyW': game.shields.top.repair(); break; case 'ArrowDown': case 'KeyS': game.shields.bottom.repair(); break; case 'ArrowLeft': case 'KeyA': game.shields.left.repair(); break; case 'ArrowRight': case 'KeyD': game.shields.right.repair(); break; }
        });

        /* GAMEPAD POLL */
        function pollGamepad() {
            const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
            let gp = null;
            for(let i=0; i<gamepads.length; i++) { if(gamepads[i] && gamepads[i].connected) { gp = gamepads[i]; break; } }
            if(gp) {
                if(!gamepadConnected) { gamepadConnected = true; gpStatus.classList.add('gp-active'); }
                const now = Date.now();
                if (game.active) {
                    if (gp.buttons[0].pressed) triggerUlti(); if (gp.buttons[2].pressed) triggerUlti();
                    if ((gp.buttons[12].pressed) || (gp.axes[1] < -0.5)) game.shields.top.repair();
                    if ((gp.buttons[13].pressed) || (gp.axes[1] > 0.5)) game.shields.bottom.repair();
                    if ((gp.buttons[14].pressed) || (gp.axes[0] < -0.5)) game.shields.left.repair();
                    if ((gp.buttons[15].pressed) || (gp.axes[0] > 0.5)) game.shields.right.repair();
                } else {
                    if (now - lastInputTime > 500) { 
                        if (gp.buttons[0].pressed || gp.buttons[9].pressed) { // A or START
                            lastInputTime = now;
                            if (currentScreen === 0) playIntro();
                            else if (currentScreen === 2) nextScreen();
                            else if (currentScreen === 3) nextScreen();
                            else if (currentScreen === 4) startGame();
                            else if (currentScreen === 6) startGame();
                        }
                    }
                }
            } else { if(gamepadConnected) { gamepadConnected = false; gpStatus.classList.remove('gp-active'); } }
            requestAnimationFrame(pollGamepad);
        }

        function nextScreen() {
            if (currentScreen === 2) { goToScreen('screen-intro-2'); currentScreen = 3; }
            else if (currentScreen === 3) { goToScreen('screen-intro-3'); currentScreen = 4; }
        }
        function goToScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => { s.classList.remove('visible'); s.classList.add('hidden'); });
            document.getElementById(screenId).classList.remove('hidden'); document.getElementById(screenId).classList.add('visible');
        }
        function startGame() {
            document.querySelectorAll('.screen').forEach(s => { s.classList.remove('visible'); s.classList.add('hidden'); });
            vicOverlay.classList.remove('burst-light'); defOverlay.classList.remove('fire-halo');
            audioVic.pause(); audioVic.currentTime = 0; audioDef99.pause(); audioDef99.currentTime = 0; audioDef100.pause(); audioDef100.currentTime = 0;
            resize(); game.active = true; currentScreen = 5; gameStartTime = Date.now();
            game.frame = 0; game.spawnedCount = 0; game.defeatedCount = 0; game.ulti = 0; game.shake = 0;
            updateUlti(); updateHUD();
            game.enemies = []; game.particles = [];
            game.shields = { top: new Shield('top', -Math.PI/2), right: new Shield('right', 0), bottom: new Shield('bottom', Math.PI/2), left: new Shield('left', Math.PI) };
            damageOverlay.style.opacity = 0; loop();
        }
        function gameOver() {
            game.active = false; currentScreen = 6; cancelAnimationFrame(animationId); damageOverlay.style.opacity = 0;
            defOverlay.classList.add('fire-halo');
            audioDef99.play().catch(e => console.log("Audio interact"));
            setTimeout(() => { document.getElementById('game-over-screen').classList.remove('hidden'); document.getElementById('game-over-screen').classList.add('visible'); }, 1000);
        }
        function winGame() {
            game.active = false; currentScreen = 6; cancelAnimationFrame(animationId); damageOverlay.style.opacity = 0;
            vicOverlay.classList.add('burst-light');
            audioVic.play().catch(e => console.log("Audio interact"));
            setTimeout(() => { document.getElementById('victory-screen').classList.remove('hidden'); document.getElementById('victory-screen').classList.add('visible'); }, 3000);
        }
        
        requestAnimationFrame(pollGamepad);
        resize();

    </script>
</body>
</html>

